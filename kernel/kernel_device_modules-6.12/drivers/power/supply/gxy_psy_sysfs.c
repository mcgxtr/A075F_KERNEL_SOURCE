// SPDX-License-Identifier: GPL-2.0

#include <linux/err.h>    /* IS_ERR, PTR_ERR */
#include <linux/init.h>        /* For init/exit macros */
#include <linux/kernel.h>
#include <linux/module.h>    /* For MODULE_ marcros  */
#include <linux/of_fdt.h>    /*of_dt API*/
#include <linux/of.h>
#include <linux/platform_device.h>    /* platform device */
#include <linux/proc_fs.h>
#include <linux/vmalloc.h>
#include <linux/power/gxy_psy_sysfs.h>
#include "mtk_battery.h"
/*Tab A9 code for SR-AX6739A-01-486 by qiaodan at 20230512 start*/
#include "mtk_charger.h"
/*Tab A9 code for SR-AX6739A-01-486 by qiaodan at 20230512 end*/
/* A07 LTE_BOS code for AL7761C-1 by xiaojian at 20250818 start */
#include "tcpm.h"
/* A07 LTE_BOS code for AL7761C-1 by xiaojian at 20250818 end */

static struct gxy_bat_hwinfo s_hwinfo_data;
/*Tab A9 code for SR-AX6739A-01-467 by hualei at 20230506 start*/
static struct gxy_usb_hwinfo s_hwinfo_usb_data;
/*Tab A9 code for SR-AX6739A-01-467 by hualei at 20230506 end*/
/*Tab A9 code for SR-AX6739A-01-521 by shanxinkai at 20230601 start*/
#if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
static struct gxy_battery_data data_t;
#endif // !CONFIG_ODM_CUSTOM_FACTORY_BUILD
/*Tab A9 code for SR-AX6739A-01-521 by shanxinkai at 20230601 end*/
/* HST11 code for P250701-05046 by zhangziyi at 20250703 start */
#if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
bool g_batt_soc_rechg = false;
EXPORT_SYMBOL(g_batt_soc_rechg);
#endif//CONFIG_ODM_CUSTOM_FACTORY_BUILD
/* HST11 code for P250701-05046 by zhangziyi at 20250703 end */
/*Tab A9_na code for AX6739N-20 by zhangziyi at 20241112 start*/
#if defined(CONFIG_CUSTOM_PROJECT_OT11_NA)
extern int battery_get_ibus_value(void);
#endif
/*Tab A9_na code for AX6739N-20 by zhangziyi at 20241112 end*/
/*HS07 code for P250416-03158 by xiongxiaoliang at 20250418 start*/
/* HST11 code for AX7800A-530 by wenyaqi at 20250427 start */
#if IS_ENABLED(CONFIG_CUSTOM_PROJECT_HS07) || IS_ENABLED(CONFIG_CUSTOM_PROJECT_HST11)
/* HST11 code for AX7800A-530 by wenyaqi at 20250427 end */
struct gxy_tag_bootmode {
	u32 size;
	u32 tag;
	u32 bootmode;
	u32 boottype;
};

enum gxy_boot_mode_t {
	NORMAL_BOOT = 0,
	META_BOOT = 1,
	RECOVERY_BOOT = 2,
	SW_REBOOT = 3,
	FACTORY_BOOT = 4,
	ADVMETA_BOOT = 5,
	ATE_FACTORY_BOOT = 6,
	ALARM_BOOT = 7,
	KERNEL_POWER_OFF_CHARGING_BOOT = 8,
	LOW_POWER_OFF_CHARGING_BOOT = 9,
	DONGLE_BOOT = 10,
	UNKNOWN_BOOT
};
#endif
/*HS07 code for P250416-03158 by xiongxiaoliang at 20250418 end*/
/* For chg_info requirement*/
/*Tab A9 code for SR-AX6739A-01-491 by qiaodan at 20230508 start*/
static const char * const GXY_BAT_CHG_INFO_TEXT[] = {
    [GXY_BAT_CHG_INFO_UNKNOWN]  =  "charger-Unknown",
    [GXY_BAT_CHG_INFO_SC89601D]  =  "1:charger-SC89601D",
    [GXY_BAT_CHG_INFO_UPM6910DS]  =  "2:charger-UPM6910DS",
    [GXY_BAT_CHG_INFO_UPM6910DH]  =  "3:charger-UPM6910DH",
    /* Tab A9 code for AX6739A-1334 by gaozhengwei at 20230620 start */
    [GXY_BAT_CHG_INFO_SGM41515D]  =  "4:charger-SGM41515D",
    /* Tab A9 code for AX6739A-1334 by gaozhengwei at 20230620 end */
    /*Tab A9_na code for AX6739NU-189 by xiongxiaoliang at 20250123 start*/
    [GXY_BAT_CHG_INFO_UPM6922]  =  "3:charger-UPM6922",
    /*Tab A9_na code for AX6739NU-189 by xiongxiaoliang at 20250123 end*/
    /*HS07 code for HS07-10 by xiongxiaoliang at 20250221 start*/
    [GXY_BAT_CHG_INFO_UPM6922P]  =  "charger-UPM6922P",
    /*HS07 code for HS07-10 by xiongxiaoliang at 20250221 end*/
    /* HS07 code for SR-AL7761A-01-164 by lina at 20250314 start */
    [GXY_BAT_CHG_INFO_SCV89601P]  =  "charger-SCV89601P",
    /* HS07 code for SR-AL7761A-01-164 by lina at 20250314 end */
};
/*Tab A9 code for SR-AX6739A-01-491 by qiaodan at 20230508 end*/

/*Tab A9  U code for P241205-09345 by yexuedong at 20241211 start*/
enum {
	SLATE_DISABLE = 0,
	SLATE_ENABLE,
	SMART_SWITCH_SLATE,
	SMART_SRC,
};
/*Tab A9  U code for P241205-09345 by yexuedong at 20241211 end*/

void gxy_bat_set_chginfo(enum gxy_bat_chg_info cinfo_data)
{
    s_hwinfo_data.cinfo = cinfo_data;
}
EXPORT_SYMBOL(gxy_bat_set_chginfo);

/*Tab A9 code for SR-AX6739A-01-482 by qiaodan at 20230516 start*/
void gxy_usb_set_pdhub_flag(bool is_pdhub)
{
    /*Tab A9 code for SR-AX6739A-01-483 by wenyaqi at 20230608 start*/
    static struct mtk_charger *s_info = NULL;
    struct power_supply *psy = NULL;

    s_hwinfo_usb_data.pdhub_flag = is_pdhub;
    GXY_PSY_INFO("%s flag is %d\n", __func__, is_pdhub);
    if (s_info == NULL) {
        psy = power_supply_get_by_name("mtk-master-charger");
        if (psy == NULL) {
            GXY_PSY_ERR("%s: get mtk-master-charger psy failed\n", __func__);
            return;
        } else {
            s_info = (struct mtk_charger *)power_supply_get_drvdata(psy);
            if (s_info == NULL) {
                GXY_PSY_ERR("%s: get mtk_charger failed\n", __func__);
                return;
            }
        }
    }
    s_info->gxy_cint.wake_up_charger(s_info);
    /*Tab A9 code for SR-AX6739A-01-483 by wenyaqi at 20230608 end*/
}
EXPORT_SYMBOL(gxy_usb_set_pdhub_flag);

bool gxy_usb_get_pdhub_flag(void)
{
    /*Tab A9 code for AX6739A-723 by qiaodan at 20230606 start*/
    GXY_PSY_INFO("%s flag is %d\n", __func__, s_hwinfo_usb_data.pdhub_flag);
    /*Tab A9 code for AX6739A-723 by qiaodan at 20230606 end*/
    return s_hwinfo_usb_data.pdhub_flag;
}
EXPORT_SYMBOL(gxy_usb_get_pdhub_flag);
/*Tab A9 code for SR-AX6739A-01-482 by qiaodan at 20230516 end*/

/*Tab A9 code for SR-AX6739A-01-467 by hualei at 20230506 start*/
void gxy_usb_set_usbccflag(enum gxy_usb_orient cc_flag)
{
    s_hwinfo_usb_data.usb_cc_flag = cc_flag;
    GXY_PSY_INFO("%s flag is %d\n", __func__, cc_flag);
}
EXPORT_SYMBOL(gxy_usb_set_usbccflag);
/*Tab A9 code for SR-AX6739A-01-467 by hualei at 20230506 end*/

/*Tab A9 code for SR-AX6739A-01-470 by wenyaqi at 20230504 start*/
/* For tcpc_info requirement*/
static const char * const GXY_BAT_TCPC_INFO_TEXT[] = {
    [GXY_BAT_TCPC_INFO_UNKNOWN]  =  "tcpc-Unknown",
    [GXY_BAT_TCPC_INFO_ET7304MQ]  =  "1:tcpc-ET7304MQ",
    [GXY_BAT_TCPC_INFO_AW35615]  =  "2:tcpc-AW35615",
    [GXY_BAT_TCPC_INFO_CPS8851MRE]  = "3:tcpc-CPS8851MRE",
    /*HS07 code for HS07-10 by xiongxiaoliang at 20250221 start*/
    [GXY_BAT_TCPC_INFO_UPM6922P]  = "tcpc-UPM6922P",
    /*HS07 code for HS07-10 by xiongxiaoliang at 20250221 end*/
    /* HS07 code for SR-AL7761A-01-164 by lina at 20250314 start */
    [GXY_BAT_TCPC_INFO_SCV89601P]  = "tcpc-SCV89601P",
    /* HS07 code for SR-AL7761A-01-164 by lina at 20250314 end */
};

/*HS07 code for HS07-39 by yexuedong at 20250227 start*/
#if defined(CONFIG_CUSTOM_PROJECT_HS07)
/*HS07 code for SR-AL7761A-01-23 by xiongxiaoliang at 20250304 start*/
enum gxy_charging_type {
    GXY_CHARGING_TYPE_NONE = 0,
    GXY_CHARGING_TYPE_UNDEFINED,
    GXY_CHARGING_TYPE_USB,
    GXY_CHARGING_TYPE_USB_CDP,
    GXY_CHARGING_TYPE_TA,
    GXY_CHARGING_TYPE_9V_TA,
    GXY_CHARGING_TYPE_PDIC_APDO,
};

static const char * const GXY_CHARGING_TYPE_TEXT[] = {
    [GXY_CHARGING_TYPE_NONE]       = "NONE",
    [GXY_CHARGING_TYPE_UNDEFINED]  = "UNDEFINED",
    [GXY_CHARGING_TYPE_USB]        = "USB",
    [GXY_CHARGING_TYPE_USB_CDP]    = "USB_CDP",
    [GXY_CHARGING_TYPE_TA]         = "TA",
    [GXY_CHARGING_TYPE_9V_TA]      = "9V_TA",
    [GXY_CHARGING_TYPE_PDIC_APDO]  = "PDIC_APDO",
};
/*HS07 code for SR-AL7761A-01-23 by xiongxiaoliang at 20250304 end*/
/*HS07 code for HS07-215 by huofudong at 20250326 start*/
/*HS07 code for HS07-2620 by huofudong at 20250507 start*/
/*HS07 code for HS07-2963 by yexuedong at 20250515 start*/
static const char * const GXY_BAT_CP_INFO_TEXT[] = {
    [GXY_BAT_CP_INFO_UNKNOWN]  =  "cp-Unknown",
    [GXY_BAT_CP_INFO_NX8530]  =  "cp-nx8530",
    [GXY_BAT_CP_INFO_SP2131]  =  "cp-sp2131",
    [GXY_BAT_CP_INFO_UPM6726]  =  "cp-upm6726",
    [GXY_BAT_CP_INFO_SGM41608]  =  "cp-sgm41608",
};
/*HS07 code for HS07-2963 by yexuedong at 20250515 end*/
/*HS07 code for HS07-2620 by huofudong at 20250507 end*/
/*HS07 code for HS07-215 by huofudong at 20250326 end*/
void gxy_bat_set_cpinfo(enum gxy_bat_cp_info pinfo_data)
{
    s_hwinfo_data.pinfo = pinfo_data;
}
EXPORT_SYMBOL(gxy_bat_set_cpinfo);
#endif
/*HS07 code for HS07-39 by yexuedong at 20250227 end*/

/*A06_V code for SR-AL7160V-01-162 by xiongxiaoliang at 20240912 start*/
static void gxy_set_bat_cycle_debug(int val)
{
    static struct mtk_battery_manager *s_info = NULL;
    struct power_supply *psy = NULL;

    if (s_info == NULL) {
        psy = power_supply_get_by_name("battery");
        if (psy == NULL) {
            GXY_PSY_ERR("%s: get battery psy failed\n", __func__);
            return;
        } else {
            s_info = (struct mtk_battery_manager *)power_supply_get_drvdata(psy);
            power_supply_put(psy);
            if (s_info == NULL) {
                GXY_PSY_ERR("%s: mtk_battery_manager is not rdy\n", __func__);
                return;
            }
        }
    }

    if (s_info->gm1 != NULL) {
        GXY_PSY_ERR("%s: set bat_cycle_debug = %d\n", __func__, s_info->gm1->bat_cycle_debug);
        s_info->gm1->bat_cycle_debug = val;
    } else {
        GXY_PSY_ERR("%s: s_info->gm1 NULL\n", __func__);
    }
}

static int gxy_get_bat_cycle_debug(void)
{
    static struct mtk_battery_manager *s_info = NULL;
    struct power_supply *psy = NULL;

    if (s_info == NULL) {
        psy = power_supply_get_by_name("battery");
        if (psy == NULL) {
            GXY_PSY_ERR("%s: get battery psy failed\n", __func__);
            goto out;
        } else {
            s_info = (struct mtk_battery_manager *)power_supply_get_drvdata(psy);
            power_supply_put(psy);
            if (s_info == NULL) {
                GXY_PSY_ERR("%s: mtk_battery_manager is not rdy\n", __func__);
                goto out;
            }
        }
    }

    if (s_info->gm1 != NULL) {
        GXY_PSY_ERR("%s: get bat_cycle_debug = %d\n", __func__, s_info->gm1->bat_cycle_debug);
        return s_info->gm1->bat_cycle_debug;
    }

out:
    return 0;
}


static int gxy_get_bat_cycle(void)
{
    static struct mtk_battery_manager *s_info = NULL;
    struct power_supply *psy = NULL;
    int batt_cycle = 0;

    if (s_info == NULL) {
        psy = power_supply_get_by_name("battery");
        if (psy == NULL) {
            GXY_PSY_ERR("%s: get battery psy failed\n", __func__);
            goto out;
        } else {
            s_info = (struct mtk_battery_manager *)power_supply_get_drvdata(psy);
            power_supply_put(psy);
            if (s_info == NULL) {
                GXY_PSY_ERR("%s: mtk_battery_manager is not rdy\n", __func__);
                goto out;
            }
        }
    }

    if (s_info->gm1 != NULL) {
       batt_cycle = s_info->gm1->bat_cycle;
    } else {
        GXY_PSY_ERR("%s: s_info->gm1 NULL\n", __func__);
    }
    GXY_PSY_ERR("%s: get bat_cycle = %d\n", __func__, batt_cycle);

out:
    return batt_cycle;
}

static int gxy_get_bat_discharge_level(void)
{
    static struct mtk_battery_manager *s_info = NULL;
    struct power_supply *psy = NULL;
    int bat_discharge_level = 0;

    if (s_info == NULL) {
        psy = power_supply_get_by_name("battery");
        if (psy == NULL) {
            GXY_PSY_ERR("%s: get battery psy failed\n", __func__);
            goto out;
        } else {
            s_info = (struct mtk_battery_manager *)power_supply_get_drvdata(psy);
            power_supply_put(psy);
            if (s_info == NULL) {
                GXY_PSY_ERR("%s: mtk_battery_manager is not rdy\n", __func__);
                goto out;
            }
        }
    }

    if (s_info->gm1 != NULL && s_info->gm1->gauge != NULL) {
        bat_discharge_level = (s_info->gm1->bat_cycle * 100) +
                (abs(s_info->gm1->gauge->fg_hw_info.ncar) * 100 / s_info->gm1->bat_cycle_thr);

        pr_err("%s: get b_c = %d, get ncar = %d, get b_c_thr = %d, get b_d_l = %d\n",
                __func__, s_info->gm1->bat_cycle, s_info->gm1->gauge->fg_hw_info.ncar,
                s_info->gm1->bat_cycle_thr, bat_discharge_level);
    } else {
        GXY_PSY_ERR("%s: s_info->gm1 or s_info->gm1->gauge is NULL\n", __func__);
    }

out:
    return bat_discharge_level;
}

static void gxy_batt_set_reset_cycle(bool val)
{
    static struct mtk_battery_manager *s_info = NULL;
    struct power_supply *psy = NULL;

    if (s_info == NULL) {
        psy = power_supply_get_by_name("battery");
        if (psy == NULL) {
            GXY_PSY_ERR("%s: get battery psy failed\n", __func__);
            return;
        } else {
            s_info = (struct mtk_battery_manager *)power_supply_get_drvdata(psy);
            power_supply_put(psy);
            if (s_info == NULL) {
                GXY_PSY_ERR("%s: mtk_battery_manager is not rdy\n", __func__);
                return;
            }
        }
    }

    if (s_info->gm1 != NULL && s_info->gm1->reset_cycle != NULL) {
        GXY_PSY_ERR("%s: s_info->reset_cycle\n", __func__);
        s_info->gm1->reset_cycle(s_info->gm1, val);
    } else {
        GXY_PSY_ERR("%s: s_info->gm1 or s_info->gm1->reset_cycle null\n", __func__);
    }
}

static int gxy_batt_get_reset_cycle(void)
{
    static struct mtk_battery_manager *s_info = NULL;
    struct power_supply *psy = NULL;

    if (s_info == NULL) {
        psy = power_supply_get_by_name("battery");
        if (psy == NULL) {
            GXY_PSY_ERR("%s: get battery psy failed\n", __func__);
            goto out;
        } else {
            s_info = (struct mtk_battery_manager *)power_supply_get_drvdata(psy);
            power_supply_put(psy);
            if (s_info == NULL) {
                GXY_PSY_ERR("%s: mtk_battery_manager is not rdy\n", __func__);
                goto out;
            }
        }
    }

    if (s_info->gm1 != NULL) {
        pr_err("%s: get reset_cycle = %d\n", __func__, s_info->gm1->is_reset_battery_cycle);
        return s_info->gm1->is_reset_battery_cycle;
    } else {
        GXY_PSY_ERR("%s: s_info->gm1 NULL\n", __func__);
    }

out:
    return -EINVAL;
}
/*A06_V code for SR-AL7160V-01-162 by xiongxiaoliang at 20240912 end*/

/*A07_BOS code for P250925-06285 by lina at 20250925 start*/
static int gxy_get_show_ag(void)
{
    static struct mtk_battery_manager *s_info = NULL;
    struct power_supply *psy = NULL;
    int show_ag = 0;
    if (s_info == NULL) {
        psy = power_supply_get_by_name("battery");
        if (psy == NULL) {
            GXY_PSY_ERR("%s: get battery psy failed\n", __func__);
            goto out;
        } else {
            s_info = (struct mtk_battery_manager *)power_supply_get_drvdata(psy);
            power_supply_put(psy);
            if (s_info == NULL) {
                GXY_PSY_ERR("%s: mtk_battery_manager is not rdy\n", __func__);
                goto out;
            }
        }
    }
    if (s_info->gm1 != NULL) {
        if ((s_info->gm1->show_ag/100 < 0) || (s_info->gm1->show_ag/100 > 100)) {
            GXY_PSY_ERR("%s: show_ag is out of range (0-100)\n", __func__);
            goto out;
        }
        show_ag = s_info->gm1->show_ag/100;
    } else {
        GXY_PSY_ERR("%s: s_info->gm1 NULL\n", __func__);
    }
    GXY_PSY_ERR("%s: get show_ag = %d\n", __func__, show_ag);
out:
    return show_ag;
}
/*A07_BOS code for P250925-06285 by lina at 20250925 end*/

/*HS07 code for HS07-39 by yexuedong at 20250227 start*/
#if defined(CONFIG_CUSTOM_PROJECT_HS07)
/*HS07 code for HS07-49 by xiongxiaoliang at 20250303 start*/
void gxy_bat_set_cp_sts(bool cp_status)
{
    s_hwinfo_data.is_en_cp = cp_status;
}
EXPORT_SYMBOL(gxy_bat_set_cp_sts);
/*HS07 code for HS07-49 by xiongxiaoliang at 20250303 end*/
/*HS07 code for SR-AL7761A-01-23 by xiongxiaoliang at 20250304 start*/
static int gxy_get_direct_charging_status(void)
{
    struct power_supply *psy = NULL;
    struct power_supply *ac_psy = NULL;
    union power_supply_propval val = {0};
    static struct mtk_charger *s_info = NULL;
    int ret = 0;
    int result = 0;

    if (s_info == NULL) {
        psy = power_supply_get_by_name("mtk-master-charger");
        if (psy == NULL) {
            GXY_PSY_ERR("%s: get mtk-master-charger psy failed\n", __func__);
            return -EINVAL;
        } else {
            s_info = (struct mtk_charger *)power_supply_get_drvdata(psy);
            if (s_info == NULL) {
                GXY_PSY_ERR("%s: get mtk_charger failed\n", __func__);
                return -EINVAL;
            }
        }
    }

    ac_psy = power_supply_get_by_name("ac");
    if (!ac_psy) {
        GXY_PSY_ERR("%s ac psy is NULL\n", __func__);
        return -EINVAL;
    }

    ret = power_supply_get_property(ac_psy,
        POWER_SUPPLY_PROP_ONLINE, &val);
    if (ret < 0) {
        GXY_PSY_ERR("%s:get ac/online property fail\n", __func__);
        return ret;
    }

    if (!s_info->enable_hv_charging) {
        result = 0;
    } else {
        if ((val.intval == 1) &&
/* A07 LTE_BOS code for AL7761C-1 by xiaojian at 20250818 start */
            (s_info->chg_pd_type == PD_CONNECT_PE_READY_SNK_APDO)) {
/* A07 LTE_BOS code for AL7761C-1 by xiaojian at 20250818 end */
            result = 1;
        }
    }

    GXY_PSY_INFO("%s:result:%d\n", __func__, result);
    return result;
}

static int gxy_get_charging_type(void)
{
    struct power_supply *psy = NULL;
    struct power_supply *ac_psy = NULL;
    struct power_supply *chg_psy = NULL;
    union power_supply_propval ac_online = {0};
    union power_supply_propval chg_usb_type = {0};
    static struct mtk_charger *s_info = NULL;
    int ret = 0;
    int result = GXY_CHARGING_TYPE_NONE;

    if (s_info == NULL) {
        psy = power_supply_get_by_name("mtk-master-charger");
        if (psy == NULL) {
            GXY_PSY_ERR("%s: get mtk-master-charger psy failed\n", __func__);
            return -EINVAL;
        } else {
            s_info = (struct mtk_charger *)power_supply_get_drvdata(psy);
            if (s_info == NULL) {
                GXY_PSY_ERR("%s: get mtk_charger failed\n", __func__);
                return -EINVAL;
            }
        }
    }

    ac_psy = power_supply_get_by_name("ac");
    if (!ac_psy) {
        GXY_PSY_ERR("%s ac psy is NULL\n", __func__);
        return -EINVAL;
    }

    ret = power_supply_get_property(ac_psy,
        POWER_SUPPLY_PROP_ONLINE, &ac_online);
    if (ret < 0) {
        GXY_PSY_ERR("%s:get ac/online property fail\n", __func__);
        return ret;
    }

/* A07 LTE_BOS code for AL7761C-1 by xiaojian at 20250807 start */
    chg_psy = power_supply_get_by_name("primary_chg");
/* A07 LTE_BOS code for AL7761C-1 by xiaojian at 20250807 end */
    if (!chg_psy) {
        GXY_PSY_ERR("%s charger psy is NULL\n", __func__);
        return -EINVAL;
    }

    ret = power_supply_get_property(chg_psy,
        POWER_SUPPLY_PROP_USB_TYPE, &chg_usb_type);
    if (ret < 0) {
        GXY_PSY_ERR("%s:get charger/usb_type property fail\n", __func__);
        return ret;
    }

    if (ac_online.intval == 1) {
        if ((s_info->afc_result == 1) ||
/* A07 LTE_BOS code for AL7761C-1 by xiaojian at 20250818 start */
            (s_info->chg_pd_type == PD_CONNECT_PE_READY_SNK_PD30)) {
            result = GXY_CHARGING_TYPE_9V_TA;
        } else if (s_info->chg_pd_type == PD_CONNECT_PE_READY_SNK_APDO) {
            result = GXY_CHARGING_TYPE_PDIC_APDO;
/* A07 LTE_BOS code for AL7761C-1 by xiaojian at 20250818 end */
        } else {
            result = GXY_CHARGING_TYPE_TA;
        }
    } else if (chg_usb_type.intval == POWER_SUPPLY_USB_TYPE_CDP) {
        result = GXY_CHARGING_TYPE_USB_CDP;
    } else if (chg_usb_type.intval == POWER_SUPPLY_USB_TYPE_SDP) {
        result = GXY_CHARGING_TYPE_USB;
    } else if (chg_usb_type.intval == POWER_SUPPLY_USB_TYPE_UNKNOWN) {
        result = GXY_CHARGING_TYPE_NONE;
    }  else {
        result = GXY_CHARGING_TYPE_UNDEFINED;
    }

    GXY_PSY_INFO("%s: result:%d\n", __func__, result);
    return result;
}
/*HS07 code for SR-AL7761A-01-23 by xiongxiaoliang at 20250304 end*/
#endif
/*HS07 code for HS07-39 by yexuedong at 20250227 end*/

void gxy_bat_set_tcpcinfo(enum gxy_bat_tcpc_info tinfo_data)
{
    s_hwinfo_data.tinfo = tinfo_data;
}
EXPORT_SYMBOL(gxy_bat_set_tcpcinfo);
/*Tab A9 code for SR-AX6739A-01-470 by wenyaqi at 20230504 end*/

/*Tab A9  U code for AX6739AU-114 by wenyaqi at 20231212 start*/
#if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
static void gxy_batt_set_slate_mode(int slate_mode)
{
    static struct mtk_charger *s_info = NULL;
    struct power_supply *psy = NULL;

    if (s_info == NULL) {
        psy = power_supply_get_by_name("mtk-master-charger");
        if (psy == NULL) {
            GXY_PSY_ERR("%s: get mtk-master-charger psy failed\n", __func__);
            return;
        } else {
            s_info = (struct mtk_charger *)power_supply_get_drvdata(psy);
            if (s_info == NULL) {
                GXY_PSY_ERR("%s: get mtk_charger failed\n", __func__);
                return;
            }
        }
    }

    GXY_PSY_INFO("%s: set slate_mode = (%d)\n", __func__, slate_mode);
    /*Tab A9  U code for P241205-09345 by yexuedong at 20241211 start*/
    if(slate_mode == SLATE_ENABLE || slate_mode == SMART_SWITCH_SLATE) {
        s_info->gxy_discharge_input_suspend = true;
    }else if(slate_mode == SLATE_DISABLE) {
        s_info->gxy_discharge_input_suspend = false;
    }
    /*Tab A9  U code for P241205-09345 by yexuedong at 20241211 end*/
    s_info->gxy_tcpc_info = s_hwinfo_data.tinfo;
    s_info->gxy_cint.set_slate_mode(s_info, slate_mode);
}
#endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
/*Tab A9  U code for AX6739AU-114 by wenyaqi at 20231212 end*/

/*HS07 code for HS07-45 by yexuedong at 20250228 start*/
#if defined(CONFIG_CUSTOM_PROJECT_HS07)
static const char * const GXY_BATTERY_TYPE_TEXT[] = {
    [GXY_BATTERY_TYPE_SDI] = "battery-SDI",
    [GXY_BATTERY_TYPE_BYD] = "battery-BYD",
    [GXY_BATTERY_TYPE_ATL] = "battery-ATL",
    [GXY_BATTERY_TYPE_GF] = "battery-GF",
    [GXY_BATTERY_TYPE_UNKNOWN] = "UNKNOWN",
};
#else
/*Tab A9 code for SR-AX6739A-01-515 by lina at 20230505 start*/
static const char * const GXY_BATTERY_TYPE_TEXT[] = {
    [GXY_BATTERY_TYPE_ATL] = "battery-ATL",
    [GXY_BATTERY_TYPE_BYD] = "battery-BYD",
    /* HST11 code for AX7800A-616 by wenyaqi at 20250425 start */
    [GXY_BATTERY_TYPE_AUTH_ATL] = "battery-auth-ATL",
    /* HST11 code for AX7800A-616 by wenyaqi at 20250425 end */
    [GXY_BATTERY_TYPE_UNKNOWN] = "UNKNOWN",
};
#endif
/*HS07 code for HS07-45 by yexuedong at 20250228 end*/
/*Tab A9 code for SR-AX6739A-01-454 by lina at 20230607 start*/
#if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
static const char * const GXY_CHARGE_TYPE_TEXT[] = {
    [POWER_SUPPLY_CHARGE_TYPE_UNKNOWN]     = "Unknown",
    [POWER_SUPPLY_CHARGE_TYPE_NONE]        = "N/A",
    [POWER_SUPPLY_CHARGE_TYPE_TRICKLE]     = "Trickle",
    [POWER_SUPPLY_CHARGE_TYPE_FAST]        = "Fast",
    /*Tab A9_na code for AX6739N-20 by zhangziyi at 20241112 start*/
    #if defined(CONFIG_CUSTOM_PROJECT_OT11_NA)
    [POWER_SUPPLY_CHARGE_TYPE_SLOW]        = "Slow",
    #endif
    /*Tab A9_na code for AX6739N-20 by zhangziyi at 20241112 end*/
    [POWER_SUPPLY_CHARGE_TYPE_TAPER_EXT]       = "Taper",
};
#endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD

/*Tab A9 code for SR-AX6739A-01-454 by lina at 20230607 end*/
void gxy_bat_set_batterytype(enum gxy_battery_type binfo_data)
{
    s_hwinfo_data.binfo = binfo_data;
}
EXPORT_SYMBOL(gxy_bat_set_batterytype);
/*Tab A9 code for SR-AX6739A-01-515 by lina at 20230505 end*/

/* HST11 code for AX7800A-632 by wenyaqi at 20250512 start */
bool gxy_is_auth_battery(void)
{
    GXY_PSY_INFO("%s battery type is %s\n", __func__, GXY_BATTERY_TYPE_TEXT[s_hwinfo_data.binfo]);

    if (strstr(GXY_BATTERY_TYPE_TEXT[s_hwinfo_data.binfo], "auth") != NULL)
    {
        return true;
    } else {
        return false;
    }
}
EXPORT_SYMBOL(gxy_is_auth_battery);
/* HST11 code for AX7800A-632 by wenyaqi at 20250512 end */

/*Tab A9 code for SR-AX6739A-01-499 by wenyaqi at 20230515 start*/

void gxy_bat_set_afc_result(int afc_result)
{
    /*Tab A9 U code for AX6739AU-127 by wenyaqi at 20240102 start*/
    static struct mtk_charger *s_info = NULL;
    struct power_supply *psy = NULL;

    if (s_info == NULL) {
        psy = power_supply_get_by_name("mtk-master-charger");
        if (psy == NULL) {
            GXY_PSY_ERR("%s: get mtk-master-charger psy failed\n", __func__);
            return;
        } else {
            s_info = (struct mtk_charger *)power_supply_get_drvdata(psy);
            if (s_info == NULL) {
                GXY_PSY_ERR("%s: get mtk_charger failed\n", __func__);
                return;
            }
        }
    }

    if (afc_result >= AFC_5V) {
        s_hwinfo_data.afc_result = 1;
        s_info->afc_result = 1;
    } else {
        s_hwinfo_data.afc_result = 0;
        s_info->afc_result = 0;
    }
    /*Tab A9 U code for AX6739AU-127 by wenyaqi at 20240102 end*/
}
EXPORT_SYMBOL(gxy_bat_set_afc_result);

void gxy_bat_set_hv_disable(int hv_disable)
{
    static struct mtk_charger *s_info = NULL;
    struct power_supply *psy = NULL;

    if (s_info == NULL) {
        psy = power_supply_get_by_name("mtk-master-charger");
        if (psy == NULL) {
            GXY_PSY_ERR("%s: get mtk-master-charger psy failed\n", __func__);
            return;
        } else {
            s_info = (struct mtk_charger *)power_supply_get_drvdata(psy);
            if (s_info == NULL) {
                GXY_PSY_ERR("%s: get mtk_charger failed\n", __func__);
                return;
            }
        }
    }

    s_info->enable_hv_charging = (hv_disable ? false: true);
    /* HST11 code for P250630-07141 by zhangziyi at 20250702 start */
    s_info->hv_disable_flag = !!hv_disable;
    GXY_PSY_INFO("%s: sep set hv_disable = (%d), hv_disable_flag = (%d)\n",
                    __func__, hv_disable, s_info->hv_disable_flag);
    /* HST11 code for P250630-07141 by zhangziyi at 20250702 end */
}
EXPORT_SYMBOL(gxy_bat_set_hv_disable);
/*Tab A9 code for SR-AX6739A-01-499 by wenyaqi at 20230515 end*/
/*HS07 code for SR-AL7761A-01-70 by xiongxiaoliang at 20250312 start*/
enum hv_charger_status {
    NORMALL_CHARGING_STS = 0,
    FAST_15W_CHARGING_STS,
    FAST_20W_CHARGING_STS,
    FAST_25W_CHARGING_STS,
    FAST_45W_CHARGING_STS,
};
/*Tab A9 code for SR-AX6739A-01-512 by wenyaqi at 20230523 start*/
#if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD) || defined(CONFIG_CUSTOM_PROJECT_HS07)
static int ss_fast_charger_status(struct mtk_charger *info)
{
    int ret = 0;
    /*Tab A9 code for NA by shanxinkai at 20250422 start*/
    int voltage_vbus_pd = 0;
    struct power_supply *usb_psy = NULL;
    union power_supply_propval prop;
    /*Tab A9 code for NA by shanxinkai at 20250422 end*/

    if (info == NULL) {
        return 0;
    }
    if (info->enable_hv_charging == false) {
        return 0;
    }

    if (s_hwinfo_data.afc_result == 1) {
        return FAST_15W_CHARGING_STS;
    }

/* A07 LTE_BOS code for AL7761C-1 by xiaojian at 20250818 start */
        if (info->chg_pd_type == PD_CONNECT_PE_READY_SNK ||
            info->chg_pd_type == PD_CONNECT_PE_READY_SNK_PD30 ||
            info->chg_pd_type == PD_CONNECT_PE_READY_SNK_APDO) {
/* A07 LTE_BOS code for AL7761C-1 by xiaojian at 20250818 end */
        /*Tab A9 code for NA by shanxinkai at 20250422 start*/
        #if defined(CONFIG_CUSTOM_PROJECT_HS07)
/* A07 LTE_BOS code for AL7761C-1 by xiaojian at 20250818 start */
        if (info->chg_pd_type == PD_CONNECT_PE_READY_SNK_APDO) {
/* A07 LTE_BOS code for AL7761C-1 by xiaojian at 20250818 end */
            /*HS07 code for HS07-4806 by xiongxiaoliang at 20250630 start*/
            #if defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
            ret = FAST_25W_CHARGING_STS;
            #else
            if ((info->pwr_max != 0) && (info->pwr_max < GXY_PD_25W_CHARGING_POWER)) {
                ret = FAST_20W_CHARGING_STS;
            } else {
                ret = FAST_25W_CHARGING_STS;
            }
            #endif
            /*HS07 code for HS07-4806 by xiongxiaoliang at 20250630 end*/
        } else {
        #endif
        /*Tab A9 code for NA by shanxinkai at 20250422 end*/
            usb_psy = power_supply_get_by_name("usb");
            if (usb_psy) {
                ret = power_supply_get_property(usb_psy,
                    POWER_SUPPLY_PROP_VOLTAGE_NOW, &prop);
                if (ret < 0) {
                    GXY_PSY_ERR("Couldn't get POWER_SUPPLY_PROP_VOLTAGE_NOW rc=%d\n", ret);
                } else {
                    voltage_vbus_pd = prop.intval;
                }
            }
            GXY_PSY_ERR("voltage_now = %d\n", voltage_vbus_pd);
            if (voltage_vbus_pd < 6000) {
                ret = NORMALL_CHARGING_STS;
            } else {
                ret = FAST_15W_CHARGING_STS;
            }
        /*Tab A9 code for NA by shanxinkai at 20250422 start*/
        #if defined(CONFIG_CUSTOM_PROJECT_HS07)
        }
        #endif
        /*Tab A9 code for NA by shanxinkai at 20250422 end*/
    }

    return ret;
}
#endif // !CONFIG_ODM_CUSTOM_FACTORY_BUILD
/*Tab A9 code for SR-AX6739A-01-512 by wenyaqi at 20230523 end*/
/*HS07 code for SR-AL7761A-01-70 by xiongxiaoliang at 20250312 end*/
/*Tab A9 code for SR-AX6739A-01-521 by shanxinkai at 20230601 start*/
#if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
static int gxy_bat_get_temp(void)
{
    static struct power_supply *s_batt_psy = NULL;
    int ret = 0;
    union power_supply_propval prop = {0};
    const int normal_temp = 250; // 25 degree

    if (s_batt_psy == NULL) {
        s_batt_psy = power_supply_get_by_name("battery");
        if (s_batt_psy == NULL) {
            GXY_PSY_ERR("%s: get battery psy failed\n", __func__);
            return normal_temp;
        }
    }
    ret = power_supply_get_property(s_batt_psy, POWER_SUPPLY_PROP_TEMP, &prop);
    if (ret < 0) {
        GXY_PSY_ERR("%s:get temp property fail\n", __func__);
        return normal_temp;
    }
    return prop.intval;
}

static int gxy_bat_get_current_now(void)
{
    static struct power_supply *s_batt_psy = NULL;
    int ret = 0;
    union power_supply_propval prop = {0};
    const int current_now = 50000; // 500ma

    if (s_batt_psy == NULL) {
        s_batt_psy = power_supply_get_by_name("battery");
        if (s_batt_psy == NULL) {
            GXY_PSY_ERR("%s: get battery psy failed\n", __func__);
            return current_now;
        }
    }
    ret = power_supply_get_property(s_batt_psy, POWER_SUPPLY_PROP_CURRENT_NOW, &prop);
    if (ret < 0) {
        GXY_PSY_ERR("%s:get temp property fail\n", __func__);
        return current_now;
    }
    return prop.intval;
}
#endif // !CONFIG_ODM_CUSTOM_FACTORY_BUILD
/*Tab A9 code for SR-AX6739A-01-521 by shanxinkai at 20230601 end*/
/*HS07 code for HS07-3330 by xiongxiaoliang at 20250522 start*/
#if (defined(CONFIG_CUSTOM_PROJECT_HS07) || defined(CONFIG_CUSTOM_PROJECT_HST11)) && !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
static int gxy_bat_get_uisoc(void)
{
    static struct power_supply *s_batt_psy = NULL;
    int ret = 0;
    union power_supply_propval prop = {0};
    const int normal_uisoc = 50;

    if (s_batt_psy == NULL) {
        s_batt_psy = power_supply_get_by_name("battery");
        if (s_batt_psy == NULL) {
            GXY_PSY_ERR("%s: get battery psy failed\n", __func__);
            return normal_uisoc;
        }
    }
    ret = power_supply_get_property(s_batt_psy, POWER_SUPPLY_PROP_CAPACITY, &prop);
    if (ret < 0) {
        GXY_PSY_ERR("%s:get capacity property fail\n", __func__);
        return normal_uisoc;
    }
    return prop.intval;
}

bool gxy_check_batt_protection_status(void)
{
    int uisoc = 0;
    static struct mtk_charger *s_info = NULL;
    struct power_supply *psy = NULL;
    bool is_stop_charging = false;

    if (s_info == NULL) {
        psy = power_supply_get_by_name("mtk-master-charger");
        if (psy == NULL) {
            return -ENODEV;
        } else {
            s_info = (struct mtk_charger *)power_supply_get_drvdata(psy);
            if (s_info == NULL) {
                return -ENODEV;
            }
        }
    }

    uisoc = gxy_bat_get_uisoc();
    if (s_info->gxy_discharge_batt_full_capacity == GXY_SLEEP_PROTECTION_FLAG ||
        s_info->gxy_discharge_batt_full_capacity == GXY_HIGHSOC_PROTECTION_FLAG) {
        if (uisoc >= GXY_PROTECT_CAPACITY_LEVEL) {
            is_stop_charging = true;
        }
    } else if (s_info->gxy_discharge_batt_full_capacity == GXY_MAX_PROTECTION_FLAG) {
        if (uisoc >= s_info->gxy_batt_max_protect_soc) {
            is_stop_charging = true;
        }
    } else {
        is_stop_charging = false;
    }
    GXY_PSY_INFO("%s: uisoc:%d, is_stop_charging:%d\n", __func__, uisoc, is_stop_charging);

    return is_stop_charging;
}
EXPORT_SYMBOL(gxy_check_batt_protection_status);
#endif
/*HS07 code for HS07-3330 by xiongxiaoliang at 20250522 end*/

/*Tab A9 code for SR-AX6739A-01-454 by lina at 20230607 start*/
/*Tab A9_na code for AX6739N-20 by zhangziyi at 20241112 start*/
#if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
static int gxy_get_chr_type(void)
{
    #if defined(CONFIG_CUSTOM_PROJECT_OT11_NA)
    static struct power_supply *chg_usb = NULL;
    static struct power_supply *chg_psy = NULL;
    union power_supply_propval usb_prop = {0};
    union power_supply_propval chr_prop = {0};
    #endif
    static struct power_supply *psy = NULL;
    union power_supply_propval prop = {0};
    int ret = 0;
    int chr_type = POWER_SUPPLY_CHARGE_TYPE_UNKNOWN;

    if (psy == NULL) {
        psy = power_supply_get_by_name("battery");
        if (psy == NULL) {
            GXY_PSY_ERR("%s: get battery psy failed\n", __func__);
            return chr_type;
        }
    }
    #if defined(CONFIG_CUSTOM_PROJECT_OT11_NA)
    if (chg_usb == NULL) {
        chg_usb = power_supply_get_by_name("charger");
        if (chg_usb == NULL) {
            GXY_PSY_ERR("%s: get chg failed\n", __func__);
            return chr_type;
        }
    }

    if (chg_psy == NULL) {
        chg_psy = power_supply_get_by_name("mtk_charger_type");
        if (chg_psy == NULL) {
            GXY_PSY_ERR("%s: get mtk_charger_type chg_psy failed\n", __func__);
            return chr_type;
        }
    }
    #endif
    ret = power_supply_get_property(psy, POWER_SUPPLY_PROP_STATUS, &prop);
    if (ret < 0) {
        GXY_PSY_ERR("%s:get battery status property fail\n", __func__);
        return chr_type;
    }

    #if defined(CONFIG_CUSTOM_PROJECT_OT11_NA)
    ret = power_supply_get_property(chg_usb, POWER_SUPPLY_PROP_USB_TYPE, &usb_prop);
    if (ret < 0) {
        GXY_PSY_ERR("%s:get usb_type status property fail\n", __func__);
        return chr_type;
    } else {
        if (usb_prop.intval == 1) {
            chr_type = 5;
            GXY_PSY_ERR("%s:get usb_type\n", __func__);
            return chr_type;
        }
    }
    #endif

    switch (prop.intval) {
        case POWER_SUPPLY_STATUS_DISCHARGING:
            chr_type = POWER_SUPPLY_CHARGE_TYPE_NONE;
            break;
        case POWER_SUPPLY_STATUS_CHARGING:
        case POWER_SUPPLY_STATUS_FULL:
            #if defined(CONFIG_CUSTOM_PROJECT_OT11_NA)
            power_supply_get_property(chg_psy,
                                POWER_SUPPLY_PROP_CHARGE_TYPE, &chr_prop);
            chr_type = chr_prop.intval;
            GXY_PSY_ERR("%s:get battery chr_type: %d\n", __func__, chr_type);
            #else
            chr_type = POWER_SUPPLY_CHARGE_TYPE_FAST;
            #endif
            break;
        default:
            chr_type = POWER_SUPPLY_CHARGE_TYPE_NONE;
            break;

    }
    return chr_type;
}
#endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
/*Tab A9_na code for AX6739N-20 by zhangziyi at 20241112 end*/
/*Tab A9 code for SR-AX6739A-01-454 by lina at 20230607 end*/
/* include attrs for battery psy */
static struct device_attribute gxy_battery_attrs[] = {
    GXY_BATTERY_ATTR(chg_info),
    /*Tab A9 code for SR-AX6739A-01-470 by wenyaqi at 20230504 start*/
    GXY_BATTERY_ATTR(tcpc_info),
    /*Tab A9 code for SR-AX6739A-01-470 by wenyaqi at 20230504 end*/
    /*Tab A9 code for SR-AX6739A-01-515 by lina at 20230505 start*/
    GXY_BATTERY_ATTR(battery_type),
    /*Tab A9 code for SR-AX6739A-01-515 by lina at 20230505 end*/
    /*Tab A9 code for SR-AX6739A-01-487 by qiaodan at 20230515 start*/
    #if defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
    GXY_BATTERY_ATTR(batt_cap_control),
    #endif //CONFIG_ODM_CUSTOM_FACTORY_BUILD
    /*Tab A9 code for SR-AX6739A-01-4867 by qiaodan at 20230515 end*/
    /*Tab A9 code for SR-AX6739A-01-457 by qiaodan at 20230522 start*/
    #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
    GXY_BATTERY_ATTR(batt_full_capacity),
    #endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
    /*Tab A9 code for SR-AX6739A-01-457 by qiaodan at 20230522 end*/
    /*Tab A9 U code for AX6739AU-127 by wenyaqi at 20240102 start*/
    #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
    GXY_BATTERY_ATTR(batt_soc_rechg),
    #endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
    GXY_BATTERY_ATTR(time_to_full_now),
    /*Tab A9 U code for AX6739AU-127 by wenyaqi at 20240102 end*/
    /*Tab A9 code for SR-AX6739A-01-455 by qiaodan at 20230524 start*/
    #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
    GXY_BATTERY_ATTR(store_mode),
    #endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
    /*Tab A9 code for SR-AX6739A-01-455 by qiaodan at 20230524 end*/
    /*Tab A9 code for SR-AX6739A-01-456 | P230713-00914 by qiaodan at 20230713 start*/
    #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
    GXY_BATTERY_ATTR(batt_slate_mode),
    #endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
    /*Tab A9 code for SR-AX6739A-01-456 | P230713-00914 by qiaodan at 20230713 end*/
    /*Tab A9 code for SR-AX6739A-01-486 by qiaodan at 20230512 start*/
    GXY_BATTERY_ATTR(input_suspend),
    /*Tab A9 code for SR-AX6739A-01-486 by qiaodan at 20230512 end*/
    /*Tab A9 code for SR-AX6739A-01-499 by wenyaqi at 20230515 start*/
    GXY_BATTERY_ATTR(afc_result),
    GXY_BATTERY_ATTR(hv_disable),
    /*Tab A9 code for SR-AX6739A-01-499 by wenyaqi at 20230515 end*/
    /*Tab A9 code for SR-AX6739A-01-512 by wenyaqi at 20230523 start*/
    /*HS07 code for SR-AL7761A-01-70 by xiongxiaoliang at 20250312 start*/
    #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD) || defined(CONFIG_CUSTOM_PROJECT_HS07)
    /*HS07 code for SR-AL7761A-01-70 by xiongxiaoliang at 20250312 end*/
    GXY_BATTERY_ATTR(hv_charger_status),
    #endif // !CONFIG_ODM_CUSTOM_FACTORY_BUILD
    /*Tab A9 code for SR-AX6739A-01-512 by wenyaqi at 20230523 end*/
    /*Tab A9 code for SR-AX6739A-01-523 by hualei at 20230516 start*/
    GXY_BATTERY_ATTR(shipmode),
    GXY_BATTERY_ATTR(shipmode_reg),
    /*Tab A9 code for SR-AX6739A-01-523 by hualei at 20230516 end*/
    /*Tab A9 code for SR-AX6739A-01-506 by hualei at 20230519 start*/
    GXY_BATTERY_ATTR(dump_charger_ic),
    /*Tab A9 code for SR-AX6739A-01-506 by hualei at 20230519 end*/
    /*Tab A9 code for SR-AX6739A-01-530 by lina at 20230530 start*/
    #ifndef CONFIG_ODM_CUSTOM_FACTORY_BUILD
    GXY_BATTERY_ATTR(batt_misc_event),
    #endif//!CONFIG_ODM_CUSTOM_FACTORY_BUILD
    /*Tab A9 code for SR-AX6739A-01-530 by lina at 20230530 end*/
    /*Tab A9 code for SR-AX6739A-01-453 by lina at 20230601 start*/
    #ifndef CONFIG_ODM_CUSTOM_FACTORY_BUILD
    GXY_BATTERY_ATTR(batt_current_event),
    #endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
    /*Tab A9 code for SR-AX6739A-01-453 by lina at 20230601 end*/
    /*Tab A9 code for SR-AX6739A-01-521 by shanxinkai at 20230601 start*/
    #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
    GXY_BATTERY_ATTR(batt_temp),
    GXY_BATTERY_ATTR(batt_discharge_level),
    GXY_BATTERY_ATTR(batt_type),
    GXY_BATTERY_ATTR(batt_current_ua_now),
    GXY_BATTERY_ATTR(battery_cycle),
    GXY_BATTERY_ATTR(reset_battery_cycle),
    #endif // !CONFIG_ODM_CUSTOM_FACTORY_BUILD
    /*Tab A9 code for SR-AX6739A-01-521 by shanxinkai at 20230601 end*/
    /*Tab A9 code for SR-AX6739A-01-454 by lina at 20230607 start*/
    #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
    GXY_BATTERY_ATTR(charge_type),
    #endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
    /*Tab A9 code for SR-AX6739A-01-454 by lina at 20230607 end*/
    /*Tab A9 U code for AX6739AU-112 by wenyaqi at 20240125 start*/
    #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
    GXY_BATTERY_ATTR(battery_cycle_debug),
    #endif // !CONFIG_ODM_CUSTOM_FACTORY_BUILD
    /*Tab A9 U code for AX6739AU-112 by wenyaqi at 20240125 end*/
    /*Tab A9_na code for AX6739N-20 by zhangziyi at 20241112 start*/
    #if defined(CONFIG_CUSTOM_PROJECT_OT11_NA)
    GXY_BATTERY_ATTR(ibus_now),
    #endif
    /*Tab A9_na code for AX6739N-20 by zhangziyi at 20241112 end*/
    /*HS07 code for HS07-39 by yexuedong at 20250227 start*/
    #if defined(CONFIG_CUSTOM_PROJECT_HS07)
    GXY_BATTERY_ATTR(cp_info),
    /*HS07 code for HS07-49 by xiongxiaoliang at 20250303 start*/
    GXY_BATTERY_ATTR(cp_enabled),
    /*HS07 code for HS07-49 by xiongxiaoliang at 20250303 end*/
    /*HS07 code for SR-AL7761A-01-23 by xiongxiaoliang at 20250304 start*/
    GXY_BATTERY_ATTR(direct_charging_status),
    GXY_BATTERY_ATTR(charging_type),
    /*HS07 code for SR-AL7761A-01-23 by xiongxiaoliang at 20250304 end*/
    #endif
    /*HS07 code for HS07-39 by yexuedong at 20250227 end*/
    /* HST11 code for AX7800A-3062 by wenyaqi at 20250627 start */
    #if IS_ENABLED(CONFIG_BATTERY_AUTH_SLE956681)
    #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
    GXY_BATTERY_ATTR(vk_key_status),
    #endif
    #endif
    /* HST11 code for AX7800A-3062 by wenyaqi at 20250627 end */
    /*A07_BOS code for P250925-06285 by lina at 20250925 start*/
    GXY_BATTERY_ATTR(state_of_health),
    /*A07_BOS code for P250925-06285 by lina at 20250925 end*/
};

/*Tab A9 code for SR-AX6739A-01-467 by hualei at 20230506 start*/
static struct device_attribute gxy_usb_attrs[] = {
    GXY_USB_ATTR(typec_cc_orientation),
};
/*Tab A9 code for SR-AX6739A-01-467 by hualei at 20230506 end*/

/* sysfs read for "battery" psd */
ssize_t gxy_bat_show_attrs(struct device *dev,
                            struct device_attribute *attr, char *buf)
{
    const ptrdiff_t offset = attr - gxy_battery_attrs;
    int count = 0;
    /*Tab A9 code for SR-AX6739A-01-523 by hualei at 20230516 start*/
    int ship_flag = 0;
    /*Tab A9 code for SR-AX6739A-01-523 by hualei at 20230516 end*/
    /*Tab A9 code for SR-AX6739A-01-506 by hualei at 20230519 start*/
    int dump_flag = 0;
    /*Tab A9 code for SR-AX6739A-01-506 by hualei at 20230519 end*/
    /*Tab A9_na code for AX6739N-20 by zhangziyi at 20241112 start*/
    #if defined(CONFIG_CUSTOM_PROJECT_OT11_NA)
    int ibus_cur = 0;
    #endif
    /*Tab A9_na code for AX6739N-20 by zhangziyi at 20241112 end*/
    int gxy_time_to_full = 0;
    /*HS07 code for SR-AL7761A-01-23 by xiongxiaoliang at 20250304 start*/
    #if defined(CONFIG_CUSTOM_PROJECT_HS07)
    int charging_type = 0;
    #endif
    /*HS07 code for SR-AL7761A-01-23 by xiongxiaoliang at 20250304 end*/

    /*Tab A9 code for SR-AX6739A-01-486 by qiaodan at 20230512 start*/
    static struct mtk_charger *s_info = NULL;
    struct power_supply *psy = NULL;
    /*Tab A9 code for SR-AX6739A-01-454 by lina at 20230607 start*/
    #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
    int charge_status = 0;
    #endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
    /*Tab A9 code for SR-AX6739A-01-454 by lina at 20230607 end*/

    if (s_info == NULL) {
        psy = power_supply_get_by_name("mtk-master-charger");
        if (psy == NULL) {
            return -ENODEV;
        } else {
            s_info = (struct mtk_charger *)power_supply_get_drvdata(psy);
            if (s_info == NULL) {
                return -ENODEV;
            }
        }
    }
    /*Tab A9 code for SR-AX6739A-01-486 by qiaodan at 20230512 end*/

    switch (offset) {
        case CHG_INFO:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%s\n",
                    GXY_BAT_CHG_INFO_TEXT[s_hwinfo_data.cinfo]);
        break;
        /*Tab A9 code for SR-AX6739A-01-470 by wenyaqi at 20230504 start*/
        case TCPC_INFO:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%s\n",
                    GXY_BAT_TCPC_INFO_TEXT[s_hwinfo_data.tinfo]);
        break;
        /*Tab A9 code for SR-AX6739A-01-470 by wenyaqi at 20230504 end*/
        /*HS07 code for HS07-39 by yexuedong at 20250227 start*/
        #if defined(CONFIG_CUSTOM_PROJECT_HS07)
        case CP_INFO:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%s\n",
                    GXY_BAT_CP_INFO_TEXT[s_hwinfo_data.pinfo]);
            break;
        /*HS07 code for HS07-49 by xiongxiaoliang at 20250303 start*/
        case CP_ENABLED:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    s_hwinfo_data.is_en_cp);
            break;
        /*HS07 code for HS07-49 by xiongxiaoliang at 20250303 end*/
        /*HS07 code for SR-AL7761A-01-23 by xiongxiaoliang at 20250304 start*/
        case DIRECT_CHARGING_STATUS:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    gxy_get_direct_charging_status());
            break;
        case CHARGING_TYPE:
            charging_type = gxy_get_charging_type();
            count += scnprintf(buf + count, PAGE_SIZE - count, "%s\n",
                    (GXY_CHARGING_TYPE_TEXT[charging_type]));
            break;
        /*HS07 code for SR-AL7761A-01-23 by xiongxiaoliang at 20250304 end*/
        #endif
        /*HS07 code for HS07-39 by yexuedong at 20250227 end*/
        /*Tab A9 code for SR-AX6739A-01-515 by lina at 20230505 start*/
        case BATTERY_TYPE:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%s\n",
                    GXY_BATTERY_TYPE_TEXT[s_hwinfo_data.binfo]);
        break;
        /*Tab A9 code for SR-AX6739A-01-515 by lina at 20230505 end*/
        /*Tab A9 code for SR-AX6739A-01-487 by qiaodan at 20230515 start*/
        #if defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
        case BATT_CAP_CONTROL:
                count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    s_info->gxy_discharge_batt_cap_control);
            break;
        #endif //CONFIG_ODM_CUSTOM_FACTORY_BUILD
        /*Tab A9 code for SR-AX6739A-01-487 by qiaodan at 20230515 end*/
        /*Tab A9 code for SR-AX6739A-01-457 by qiaodan at 20230522 start*/
        #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
        case BATT_FULL_CAPACITY:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    s_info->gxy_discharge_batt_full_capacity);
            break;
        #endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
        /*Tab A9 code for SR-AX6739A-01-457 by qiaodan at 20230522 end*/
        /*Tab A9 U code for AX6739AU-127 by wenyaqi at 20240102 start*/
        #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
        case BATT_SOC_RECHG:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    s_info->gxy_batt_soc_rechg);
            break;
        #endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
        case TIME_TO_FULL_NOW:
            gxy_time_to_full = s_info->gxy_cint.batt_timetofull();
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    gxy_time_to_full);
            break;
        /*Tab A9 U code for AX6739AU-127 by wenyaqi at 20240102 end*/
        /*Tab A9 code for SR-AX6739A-01-455 by qiaodan at 20230524 start*/
        #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
        case STORE_MODE:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    s_info->gxy_discharge_store_mode);
            break;
        #endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
        /*Tab A9 code for SR-AX6739A-01-455 by qiaodan at 20230524 end*/
        /*Tab A9 code for SR-AX6739A-01-456 | P230713-00914 by qiaodan at 20230713 start*/
        #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
        case BATT_SLATE_MODE:
        #endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
        /*Tab A9 code for SR-AX6739A-01-456 | P230713-00914 by qiaodan at 20230713 end*/
        /*Tab A9 code for SR-AX6739A-01-486 by qiaodan at 20230512 start*/
        case INPUT_SUSPEND:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    s_info->gxy_discharge_input_suspend);
            break;
        /*Tab A9 code for SR-AX6739A-01-486 by qiaodan at 20230512 end*/
        /*Tab A9 code for SR-AX6739A-01-499 by wenyaqi at 20230515 start*/
        case AFC_RESULT:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    s_hwinfo_data.afc_result);
            break;
        case HV_DISABLE:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    (s_info->enable_hv_charging ? 0 : 1));
            break;
        /*Tab A9 code for SR-AX6739A-01-499 by wenyaqi at 20230515 end*/
        /*Tab A9 code for SR-AX6739A-01-512 by wenyaqi at 20230523 start*/
        /*HS07 code for SR-AL7761A-01-70 by xiongxiaoliang at 20250312 start*/
        #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD) || defined(CONFIG_CUSTOM_PROJECT_HS07)
        /*HS07 code for SR-AL7761A-01-70 by xiongxiaoliang at 20250312 end*/
        case HV_CHARGER_STATUS:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    (ss_fast_charger_status(s_info)));
            break;
        #endif // !CONFIG_ODM_CUSTOM_FACTORY_BUILD
        /*Tab A9 code for SR-AX6739A-01-512 by wenyaqi at 20230523 end*/
        /*Tab A9 code for SR-AX6739A-01-523 by hualei at 20230516 start*/
        case SHIPMODE:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    s_info->gxy_shipmode_flag);
            break;
        case SHIPMODE_REG:
            ship_flag = s_info->gxy_cint.get_ship_mode(s_info);
            GXY_PSY_INFO("get ship mode reg = %d\n",ship_flag);
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    ship_flag);
            break;
        /*Tab A9 code for SR-AX6739A-01-523 by hualei at 20230516 end*/
        /*Tab A9 code for SR-AX6739A-01-506 by hualei at 20230519 start*/
        case DUMP_CHARGER_IC:
            dump_flag = s_info->gxy_cint.dump_charger_ic(s_info);
            GXY_PSY_INFO("dump_charger_ic = %d\n", dump_flag);
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    dump_flag);
            break;
        /*Tab A9 code for SR-AX6739A-01-506 by hualei at 20230519 end*/
        /*Tab A9 code for SR-AX6739A-01-530 by lina at 20230530 start*/
        #ifndef CONFIG_ODM_CUSTOM_FACTORY_BUILD
        case BATT_MISC_EVENT:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                s_info->gxy_cint.batt_misc_event(s_info));
            break;
        #endif//!CONFIG_ODM_CUSTOM_FACTORY_BUILD
        /*Tab A9 code for SR-AX6739A-01-530 by lina at 20230530 end*/
        /*Tab A9 code for SR-AX6739A-01-453 by lina at 20230601 start*/
        #ifndef CONFIG_ODM_CUSTOM_FACTORY_BUILD
        case BATT_CURRENT_EVENT:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                s_info->gxy_cint.batt_current_event(s_info));
            break;
        #endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
        /*Tab A9 code for SR-AX6739A-01-453 by lina at 20230601 end*/
        /*Tab A9 code for SR-AX6739A-01-521 by shanxinkai at 20230601 start*/
        #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
        case BATT_TEMP:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    (gxy_bat_get_temp()));
            break;
        case BATT_DISCHARGE_LEVEL:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    (gxy_get_bat_discharge_level()));
            break;
        case BATT_TYPE:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%s\n",
                    data_t.cust_batt_type);
            break;
        case BATT_CURRENT_UA_NOW:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    (gxy_bat_get_current_now()));
            break;
        case BATTERY_CYCLE:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    (gxy_get_bat_cycle()));
            break;
        case RESET_BATTERY_CYCLE:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    (gxy_batt_get_reset_cycle()));
            break;
        #endif // !CONFIG_ODM_CUSTOM_FACTORY_BUILD
        /*Tab A9 code for SR-AX6739A-01-521 by shanxinkai at 20230601 end*/
        /*Tab A9 code for SR-AX6739A-01-454 by lina at 20230607 start*/
        #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
        case CHARGE_TYPE:
            charge_status = gxy_get_chr_type();
            count += scnprintf(buf + count, PAGE_SIZE - count, "%s\n",
                    (GXY_CHARGE_TYPE_TEXT[charge_status]));
            break;
        #endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
        /*Tab A9 code for SR-AX6739A-01-454 by lina at 20230607 end*/
        /*Tab A9 U code for AX6739AU-112 by wenyaqi at 20240125 start*/
        #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
        case BATTERY_CYCLE_DEBUG:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    (gxy_get_bat_cycle_debug()));
            break;
        #endif // !CONFIG_ODM_CUSTOM_FACTORY_BUILD
        /*Tab A9 U code for AX6739AU-112 by wenyaqi at 20240125 end*/
        /*Tab A9_na code for AX6739N-20 by zhangziyi at 20241112 start*/
        #if defined(CONFIG_CUSTOM_PROJECT_OT11_NA)
        case IBUS_NOW:
            ibus_cur = battery_get_ibus_value() * 2;
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    ibus_cur);
            GXY_PSY_INFO("ibus_now %d\n", ibus_cur);
            break;
        #endif
        /*Tab A9_na code for AX6739N-20 by zhangziyi at 20241112 end*/
        /* HST11 code for AX7800A-3062 by wenyaqi at 20250627 start */
        #if IS_ENABLED(CONFIG_BATTERY_AUTH_SLE956681)
        #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
        case VK_KEY_STATUS:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                s_hwinfo_data.vk_key_status);
            break;
        #endif
        #endif
        /* HST11 code for AX7800A-3062 by wenyaqi at 20250627 end */
        /*A07_BOS code for P250925-06285 by lina at 20250925 start*/
        case STATE_OF_HEALTH:
            count += scnprintf(buf + count, PAGE_SIZE - count, "%d\n",
                    (gxy_get_show_ag()));
            break;
        /*A07_BOS code for P250925-06285 by lina at 20250925 end*/
    default:
        count = -EINVAL;
        break;
    }
    return count;
}

/*Tab A9_V code for P241221-02215 by xiongxiaoliang at 20250108 start*/
#if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
static int atoi(const char *str)
{
    int result = 0;
    int count = 0;

    if (str == NULL)
        return -EIO;

    while (str[count] != 0	/* NULL */
        && str[count] >= '0' && str[count] <= '9') {
        result = result * 10 + str[count] - '0';
        ++count;
    }

    return result;
}

static int gxy_extract_Before_Space(const char *str) {
    int count = 0;
    char temp[5] = {};
    int value = 0;
    char *space = strchr(str, ' ');

    if (space != NULL) {
        count = space - str;
        strncpy(temp, str, count);
        temp[count] = '\0';
        value = atoi(temp);
        GXY_PSY_INFO("%s: max_soc_string=%s, (%d, %d)\n", __func__, str, count, value);
    } else {
        GXY_PSY_ERR("%s: space is NULL, str= (%s)\n", __func__, str);
    }

    return value;
}
#endif
/*Tab A9_V code for P241221-02215 by xiongxiaoliang at 20250108 end*/

/*Tab A9 code for P230713-00914 by qiaodan at 20230724 start*/
/* sysfs write for "battery" psd */
ssize_t gxy_bat_store_attrs(
                    struct device *dev,
                    struct device_attribute *attr,
                    const char *buf, size_t count)
{
    const ptrdiff_t offset = attr - gxy_battery_attrs;
    int ret = -EINVAL;
    /*Tab A9 code for SR-AX6739A-01-486 by qiaodan at 20230512 start*/
    static struct mtk_charger *s_info = NULL;
    struct power_supply *psy = NULL;
    int value = 0;
    /*Tab A9_V code for P241221-02215 by xiongxiaoliang at 20250108 start*/
    #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
    int gxy_max_soc = 0;
    #endif
    /*Tab A9_V code for P241221-02215 by xiongxiaoliang at 20250108 end*/

    if (s_info == NULL) {
        psy = power_supply_get_by_name("mtk-master-charger");
        if (psy == NULL) {
            return -ENODEV;
        } else {
            s_info = (struct mtk_charger *)power_supply_get_drvdata(psy);
            if (s_info == NULL) {
                return -ENODEV;
            }
        }
    }
    /*Tab A9 code for SR-AX6739A-01-486 by qiaodan at 20230512 end*/

    switch (offset) {
        /*Tab A9 code for SR-AX6739A-01-487 by qiaodan at 20230515 start*/
        #if defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
        case BATT_CAP_CONTROL:
            if (sscanf(buf, "%10d\n", &value) == 1) {
                s_info->gxy_discharge_batt_cap_control = !!value;
                GXY_PSY_INFO("%s: set batt_cap_control = (%d)\n", __func__, value);
                ret = count;
            }
            break;
        #endif //CONFIG_ODM_CUSTOM_FACTORY_BUILD
        /*Tab A9 code for SR-AX6739A-01-487 by qiaodan at 20230515 end*/
        /*Tab A9 U code for AX6739AU-127 by wenyaqi at 20240102 start*/
        /*Tab A9 code for SR-AX6739A-01-457 by qiaodan at 20230522 start*/
        #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
        /*Tab A9_V code for P241221-02215 by xiongxiaoliang at 20250108 start*/
        case BATT_FULL_CAPACITY:
            /*HS07 code for P250416-03158 by xiongxiaoliang at 20250418 start*/
            /* HST11 code for AX7800A-530 by wenyaqi at 20250427 start */
            #if IS_ENABLED(CONFIG_CUSTOM_PROJECT_HS07) || IS_ENABLED(CONFIG_CUSTOM_PROJECT_HST11)
            /* HST11 code for AX7800A-530 by wenyaqi at 20250427 end */
            if (!strncmp(buf, gs_basic_protection, (count-1))) {
                s_info->gxy_discharge_batt_full_capacity = GXY_FULL_CAPACITY_LEVEL;
            } else if (strstr(buf, gs_maximum_protection)) {
                s_info->gxy_discharge_batt_full_capacity = GXY_MAX_PROTECTION_FLAG;
                gxy_max_soc = gxy_extract_Before_Space(buf);
                if (gxy_max_soc > 0 && gxy_max_soc <= 100) {
                    /*HS07 code for HS07-4657 by xiongxiaoliang at 20250620 start*/
                    if (gxy_max_soc != s_info->gxy_batt_max_protect_soc) {
                        s_info->gxy_discharge_batt_full_flag = false;
                    }
                    /*HS07 code for HS07-4657 by xiongxiaoliang at 20250620 end*/
                    s_info->gxy_batt_max_protect_soc = gxy_max_soc;
                }
            } else if (strstr(buf, gs_sleep_protection)) {
                s_info->gxy_discharge_batt_full_capacity = GXY_SLEEP_PROTECTION_FLAG;
            } else if (strstr(buf, gs_highsoc_protection)) {
                s_info->gxy_discharge_batt_full_capacity = GXY_HIGHSOC_PROTECTION_FLAG;
            } else if (KERNEL_POWER_OFF_CHARGING_BOOT == s_hwinfo_data.bootmode ||
                       LOW_POWER_OFF_CHARGING_BOOT == s_hwinfo_data.bootmode) {
                s_info->gxy_discharge_batt_full_capacity = GXY_MAX_PROTECTION_FLAG;
                gxy_max_soc = atoi(buf);
                if (gxy_max_soc > 0 && gxy_max_soc <= 100) {
                    s_info->gxy_batt_max_protect_soc = gxy_max_soc;
                }
            } else {
                GXY_PSY_ERR("%s: Setting Value incorrect, cancel batt protection, %s %d\n",
                    __func__, buf, s_info->gxy_discharge_batt_full_capacity);
            }
            GXY_PSY_ERR("%s:set batt protection, type=%s value=%d, max_soc=%d, bootmode=%d\n", __func__,
                buf, s_info->gxy_discharge_batt_full_capacity, s_info->gxy_batt_max_protect_soc,
                s_hwinfo_data.bootmode);
            #else
            if (!strncmp(buf, gs_basic_protection, (count-1))) {
                s_info->gxy_discharge_batt_full_capacity = GXY_FULL_CAPACITY_LEVEL;
            } else if (strstr(buf, gs_maximum_protection)) {
                s_info->gxy_discharge_batt_full_capacity = GXY_MAX_PROTECTION_FLAG;
                gxy_max_soc = gxy_extract_Before_Space(buf);
                if (gxy_max_soc > 0 && gxy_max_soc <= 100) {
                    /*HS07 code for HS07-4657 by xiongxiaoliang at 20250620 start*/
                    if (gxy_max_soc != s_info->gxy_batt_max_protect_soc) {
                        s_info->gxy_discharge_batt_full_flag = false;
                    }
                    /*HS07 code for HS07-4657 by xiongxiaoliang at 20250620 end*/
                    s_info->gxy_batt_max_protect_soc = gxy_max_soc;
                }
            } else if (!strncmp(buf, gs_sleep_protection, (count-1))) {
                s_info->gxy_discharge_batt_full_capacity = GXY_SLEEP_PROTECTION_FLAG;
            } else if (!strncmp(buf, gs_highsoc_protection, (count-1))) {
                s_info->gxy_discharge_batt_full_capacity = GXY_HIGHSOC_PROTECTION_FLAG;
            } else {
                GXY_PSY_ERR("%s: Setting Value incorrect, cancel batt protection, %s %d\n",
                    __func__, buf, s_info->gxy_discharge_batt_full_capacity);
            }
            GXY_PSY_ERR("%s:set batt protection, type=%s value=%d, max_soc=%d\n", __func__, buf,
                s_info->gxy_discharge_batt_full_capacity, s_info->gxy_batt_max_protect_soc);
            #endif
            /*HS07 code for P250416-03158 by xiongxiaoliang at 20250418 end*/
            ret = count;
            break;
        /*Tab A9_V code for P241221-02215 by xiongxiaoliang at 20250108 end*/
        #endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
        /*Tab A9 code for SR-AX6739A-01-457 by qiaodan at 20230522 end*/
        #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
        case BATT_SOC_RECHG:
            if (sscanf(buf, "%10d\n", &value) == 1) {
                s_info->gxy_batt_soc_rechg = !!value;
                ret = count;
            }
            GXY_PSY_ERR("%s:set batt_soc_rechg %d\n", __func__, value);
            break;
        #endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
        /*Tab A9 U code for AX6739AU-127 by wenyaqi at 20240102 end*/
        /*Tab A9 code for SR-AX6739A-01-455 by qiaodan at 20230524 start*/
        #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
        case STORE_MODE:
            if (sscanf(buf, "%10d\n", &value) == 1) {
                s_info->gxy_discharge_store_mode = !!value;
                GXY_PSY_INFO("%s: set store_mode = (%d)\n", __func__, value);
                ret = count;
            }
            break;
        #endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
        /*Tab A9 code for SR-AX6739A-01-455 by qiaodan at 20230524 end*/
        /*Tab A9 code for SR-AX6739A-01-456 | P230713-00914 by qiaodan at 20230713 start*/
        /*Tab A9  U code for AX6739AU-114 by wenyaqi at 20231212 start*/
        #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
        case BATT_SLATE_MODE:
            if (sscanf(buf, "%10d\n", &value) == 1) {
                gxy_batt_set_slate_mode(value);
                ret = count;
            }
            break;
        #endif //!CONFIG_ODM_CUSTOM_FACTORY_BUILD
        /*Tab A9  U code for AX6739AU-114 by wenyaqi at 20231212 end*/
        /*Tab A9 code for SR-AX6739A-01-456 | P230713-00914 by qiaodan at 20230713 end*/
        /*Tab A9 code for SR-AX6739A-01-486 by qiaodan at 20230512 start*/
        case INPUT_SUSPEND:
            if (sscanf(buf, "%10d\n", &value) == 1) {
                s_info->gxy_discharge_input_suspend = value;
                GXY_PSY_INFO("%s: set input_suspend = (%d)\n", __func__, value);
                ret = count;
            }
            break;
        /*Tab A9 code for SR-AX6739A-01-486 by qiaodan at 20230512 end*/
        /*Tab A9 code for SR-AX6739A-01-499 by wenyaqi at 20230515 start*/
        case HV_DISABLE:
            if (sscanf(buf, "%10d\n", &value) == 1) {
                gxy_bat_set_hv_disable(value);
                ret = count;
            }
            break;
        /*Tab A9 code for SR-AX6739A-01-499 by wenyaqi at 20230515 end*/
        /*Tab A9 code for SR-AX6739A-01-523 by hualei at 20230516 start*/
        case SHIPMODE:
            if (sscanf(buf, "%10d\n", &value) == 1) {
                s_info->gxy_shipmode_flag = !!value;
                s_info->gxy_cint.set_ship_mode(s_info, s_info->gxy_shipmode_flag);
                GXY_PSY_INFO("%s: enable shipmode val = %d\n",__func__, value);
                ret = count;
            }
            break;
        /*Tab A9 code for SR-AX6739A-01-523 by hualei at 20230516 end*/
        /*Tab A9 code for SR-AX6739A-01-521 by shanxinkai at 20230601 start*/
        #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
        case BATT_TYPE:
            strncpy(data_t.cust_batt_type, buf, count);
            data_t.cust_batt_type[count] = '\0';
            ret = count;
            break;
        case RESET_BATTERY_CYCLE:
            if (sscanf(buf, "%10d\n", &value) == 1) {
                gxy_batt_set_reset_cycle(!!value);
                GXY_PSY_INFO("%s: set reset_cycle = (%d)\n", __func__, value);
                ret = count;
            }
            break;
        #endif // !CONFIG_ODM_CUSTOM_FACTORY_BUILD
        /*Tab A9 code for SR-AX6739A-01-521 by shanxinkai at 20230601 end*/
        /*Tab A9 U code for AX6739AU-112 by wenyaqi at 20240125 start*/
        #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
        case BATTERY_CYCLE_DEBUG:
            if (sscanf(buf, "%10d\n", &value) == 1) {
                gxy_set_bat_cycle_debug(value);
                GXY_PSY_INFO("%s: set bat_cycle_debug = (%d)\n", __func__, value);
                ret = count;
            }
            break;
        #endif // !CONFIG_ODM_CUSTOM_FACTORY_BUILD
        /*Tab A9 U code for AX6739AU-112 by wenyaqi at 20240125 end*/
        /* HST11 code for AX7800A-3062 by wenyaqi at 20250627 start */
        #if IS_ENABLED(CONFIG_BATTERY_AUTH_SLE956681)
        #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
        case VK_KEY_STATUS:
            if (sscanf(buf, "%10d\n", &value) == 1) {
                s_hwinfo_data.vk_key_status = value;
                GXY_PSY_INFO("%s: vk_key_status  (%d)\n", __func__, value);
                ret = count;
            }
            break;
        #endif
        #endif
        /* HST11 code for AX7800A-3062 by wenyaqi at 20250627 end */
        default:
            ret = -EINVAL;
            break;
    }

    /*Tab A9 code for SR-AX6739A-01-486 by qiaodan at 20230514 start*/
    s_info->gxy_cint.wake_up_charger(s_info);
    /*Tab A9 code for SR-AX6739A-01-486 by qiaodan at 20230514 end*/

    return ret;
}
/*Tab A9 code for P230713-00914 by qiaodan at 20230724 end*/

/*Tab A9 code for SR-AX6739A-01-467 by hualei at 20230506 start*/
/* sysfs read for "usb" psd */
ssize_t gxy_usb_show_attrs(struct device *dev,
                            struct device_attribute *attr, char * buf)
{
    const ptrdiff_t offset = attr - gxy_usb_attrs;
    int count = 0;

    switch (offset) {
        case TYPEC_CC_ORIENT:
            count = sprintf(buf, "%d\n", s_hwinfo_usb_data .usb_cc_flag);
            break;
    default:
        count = -EINVAL;
        break;
    }
    return count;
}

/* sysfs write for "usb" psd */
ssize_t gxy_usb_store_attrs(
                    struct device *dev,
                    struct device_attribute *attr,
                    const char *buf, size_t count)
{
    const ptrdiff_t offset = attr - gxy_usb_attrs;
    int ret = -EINVAL;

    switch (offset) {
        default:
            ret = -EINVAL;
            break;
    }

    return ret;
}
/*Tab A9 code for SR-AX6739A-01-467 by hualei at 20230506 end*/

static int gxy_battery_create_attrs(struct device *dev)
{
    unsigned long i = 0;
    int ret = 0;

    for (i = 0; i < ARRAY_SIZE(gxy_battery_attrs); i++) {
        ret = device_create_file(dev, &gxy_battery_attrs[i]);
        if (ret) {
            goto create_attrs_failed;
        }
    }
    goto create_attrs_succeed;

create_attrs_failed:
    GXY_PSY_ERR("%s: %lu %s failed (%d)\n", __func__, i, gxy_battery_attrs[i].attr.name, ret);
    while (i--) {
        device_remove_file(dev, &gxy_battery_attrs[i]);
    }

create_attrs_succeed:
    return ret;
}

/*Tab A9 code for SR-AX6739A-01-467 by hualei at 20230506 start*/
static int gxy_usb_create_attrs(struct device *dev)
{
    unsigned long i = 0;
    int ret = 0;

    for (i = 0; i < ARRAY_SIZE(gxy_usb_attrs); i++) {
        ret = device_create_file(dev, &gxy_usb_attrs[i]);
        if (ret) {
            goto create_attrs_failed;
        }
    }
    goto create_attrs_succeed;

create_attrs_failed:
    GXY_PSY_ERR("%s: failed (%d)\n", __func__, ret);
    while (i--) {
        device_remove_file(dev, &gxy_usb_attrs[i]);
    }

create_attrs_succeed:
    return ret;
}
/*Tab A9 code for SR-AX6739A-01-467 by hualei at 20230506  end*/

static int gxy_psy_probe(struct platform_device *pdev)
{
    int ret = 0;
    /*HS07 code for P250416-03158 by xiongxiaoliang at 20250418 start*/
    /* HST11 code for AX7800A-530 by wenyaqi at 20250427 start */
    #if IS_ENABLED(CONFIG_CUSTOM_PROJECT_HS07) || IS_ENABLED(CONFIG_CUSTOM_PROJECT_HST11)
    /* HST11 code for AX7800A-530 by wenyaqi at 20250427 end */
    struct device_node *boot_node = NULL;
    struct gxy_tag_bootmode *tag = NULL;
    #endif
    /*HS07 code for P250416-03158 by xiongxiaoliang at 20250418 end*/
    struct gxy_battery *g_batt = devm_kzalloc(&pdev->dev, sizeof(*g_batt), GFP_KERNEL);

    if (!g_batt) {
        GXY_PSY_ERR("%s dont not kzmalloc\n", __func__);
        return -ENOMEM;
    }

    GXY_PSY_INFO("enter\n");
    /*HS07 code for P250416-03158 by xiongxiaoliang at 20250418 start*/
    /* HST11 code for AX7800A-530 by wenyaqi at 20250427 start */
    #if IS_ENABLED(CONFIG_CUSTOM_PROJECT_HS07) || IS_ENABLED(CONFIG_CUSTOM_PROJECT_HST11)
    /* HST11 code for AX7800A-530 by wenyaqi at 20250427 end */
    boot_node = of_find_node_by_path("/chosen");
    if (!boot_node) {
        boot_node = of_find_node_by_path("/chosen@0");
    }

    if (boot_node) {
        tag = (struct gxy_tag_bootmode *)of_get_property(boot_node, "atag,boot", NULL);
        if (!tag) {
            pr_err("%s: failed to get atag,boot\n", __func__);
        } else {
            pr_err("%s: size:0x%x tag:0x%x bootmode:0x%x boottype:0x%x\n",
                __func__, tag->size, tag->tag, tag->bootmode, tag->boottype);
            s_hwinfo_data.bootmode = tag->bootmode;
        }
    } else {
        pr_err("%s: failed to get /chosen and /chosen@0\n", __func__);
    }
    #endif
    /*HS07 code for P250416-03158 by xiongxiaoliang at 20250418 end*/
    g_batt->psy = power_supply_get_by_name("battery");
    if (IS_ERR_OR_NULL(g_batt->psy)) {
        return -EPROBE_DEFER;
    }

    ret = gxy_battery_create_attrs(&g_batt->psy->dev);
    if (ret) {
        GXY_PSY_ERR("%s battery fail to create attrs!!\n", __func__);
        return ret;
    }

    GXY_PSY_INFO("%s Battery Install Success !!\n", __func__);

    /*Tab A9 code for SR-AX6739A-01-467 by hualei at 20230506 start*/
    g_batt->usb_psy = power_supply_get_by_name("usb");
    if (IS_ERR_OR_NULL(g_batt->usb_psy)) {
        return -EPROBE_DEFER;
    }
    ret = gxy_usb_create_attrs(&g_batt->usb_psy->dev);
    if (ret) {
        GXY_PSY_ERR("%s usb fail to create attrs!!\n", __func__);
    }
    GXY_PSY_INFO("%s USB Install Success !!\n", __func__);
    /*Tab A9 code for SR-AX6739A-01-467 by hualei at 20230506 end*/

    /* HST11 code for AX7800A-3062 by wenyaqi at 20250627 start */
    #if IS_ENABLED(CONFIG_BATTERY_AUTH_SLE956681)
    #if !defined(CONFIG_ODM_CUSTOM_FACTORY_BUILD)
    s_hwinfo_data.vk_key_status = -1;
    #endif
    #endif
    /* HST11 code for AX7800A-3062 by wenyaqi at 20250627 end */
    return 0;
}

static void gxy_psy_remove(struct platform_device *pdev)
{
//    return 0;
}

static const struct of_device_id gxy_psy_of_match[] = {
    {.compatible = "gxy, gxy_psy",},
    {},
};

MODULE_DEVICE_TABLE(of, gxy_psy_of_match);

static struct platform_driver gxy_psy_driver = {
    .probe = gxy_psy_probe,
    .remove = gxy_psy_remove,
    .driver = {
        .name = "gxy_psy",
        .of_match_table = of_match_ptr(gxy_psy_of_match),
    },
};

static int __init gxy_psy_init(void)
{
    GXY_PSY_INFO("init\n");

    return platform_driver_register(&gxy_psy_driver);
}
late_initcall(gxy_psy_init);

static void __exit gxy_psy_exit(void)
{
    platform_driver_unregister(&gxy_psy_driver);
}
module_exit(gxy_psy_exit);

MODULE_AUTHOR("Lucas-Gao");
MODULE_DESCRIPTION("gxy psy driver");
MODULE_LICENSE("GPL");
