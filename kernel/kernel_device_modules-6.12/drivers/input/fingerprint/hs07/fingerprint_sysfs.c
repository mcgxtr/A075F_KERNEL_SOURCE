/*
 * Copyright (C) 2017 Samsung Electronics. All rights reserved.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * version 2 as published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 */

/*
 *  fingerprint sysfs class
 */

#include <linux/module.h>
#include <linux/types.h>
#include <linux/init.h>
#include <linux/device.h>
#include <linux/fs.h>
#include <linux/err.h>
#include <linux/pinctrl/consumer.h>
#include <linux/errno.h>
#include <linux/of_device.h>

int adm_flag = 0;
/*HS07 code for HS07-592 by yuli at 20250411 start*/
char position_str[64] = "52.65,13.98";
/*HS07 code for HS07-592 by yuli at 20250411 end*/
int finger_sysfs = 0;

EXPORT_SYMBOL_GPL(finger_sysfs);

struct class *fingerprint_class = NULL;
struct device *adm_dev = NULL;

/*
 * Create sysfs interface
 */
static ssize_t fingerprint_adm_show(struct device *dev,
			struct device_attribute *attr, char *buf)
{
	pr_info("%s: finger_sysfs = %d\n", __func__, finger_sysfs);

	if (finger_sysfs) {
		return snprintf(buf, PAGE_SIZE, "%d\n", 1);
	} else {
		return snprintf(buf, PAGE_SIZE, "%d\n", 0);
	}
}

/*HS07 code for HS07-592 by yuli at 20250411 start*/
/* A07 LTE_BOS code for AL7761C-1 by dingying at 20250804 start */
static ssize_t fingerprint_position_store(struct device *dev,
			struct device_attribute *attr,
			const char *buf, size_t count)
{
	if (strchr(buf, ',') == NULL) {
		pr_err( "Invalid format");
		return -EINVAL;
	}
	strncpy(position_str, buf, sizeof(position_str));
	position_str[sizeof(position_str) - 1UL] = '\0';
	return count;
}
/* A07 LTE_BOS code for AL7761C-1 by dingying at 20250804 end */
static ssize_t fingerprint_position_show(struct device *dev,
			struct device_attribute *attr, char *buf)
{
	return snprintf(buf, PAGE_SIZE, "%s\n", position_str);
}
static DEVICE_ATTR(position, 0664, fingerprint_position_show, fingerprint_position_store);
/*HS07 code for HS07-592 by yuli at 20250411 end*/

static DEVICE_ATTR(adm, 0444, fingerprint_adm_show, NULL);

static struct device_attribute *fps_attrs[] = {
	&dev_attr_adm,
	/*HS07 code for HS07-592 by yuli at 20250411 start*/
	&dev_attr_position,
	/*HS07 code for HS07-592 by yuli at 20250411 end*/
	NULL,
};

static int __init fingerprint_class_init(void)
{
	int i = 0;

	pr_info("%s\n", __func__);

	fingerprint_class = class_create("fingerprint");

	if (IS_ERR(fingerprint_class)) {
		pr_err("%s: create fingerprint_class is failed.\n", __func__);
		return PTR_ERR(fingerprint_class);
	}

	fingerprint_class->dev_uevent = NULL;

	adm_dev =
	    device_create(fingerprint_class, NULL, 0, NULL, "fingerprint");

	if (IS_ERR(adm_dev)) {
		pr_err("%s: device_create failed!\n", __func__);
		class_destroy(fingerprint_class);
		return PTR_ERR(adm_dev);
	}

	for (i = 0; fps_attrs[i] != NULL; i++) {
		adm_flag = device_create_file(adm_dev, fps_attrs[i]);

		if (adm_flag) {
			pr_err
			    ("%s: fail device_create_file (adm_dev, fps_attrs[%d])\n",
			     __func__, i);
			device_destroy(fingerprint_class, 0);
			class_destroy(fingerprint_class);
			return adm_flag;
		}
	}

	return 0;
}

static void __exit fingerprint_class_exit(void)
{
	int i = 0;

	for (i = 0; fps_attrs[i] != NULL; i++) {
		if (!adm_flag) {
			device_remove_file(adm_dev, &dev_attr_adm);
			device_destroy(fingerprint_class, 0);
			class_destroy(fingerprint_class);
		}
	}
	fingerprint_class = NULL;
}

subsys_initcall(fingerprint_class_init);
module_exit(fingerprint_class_exit);

MODULE_DESCRIPTION("fingerprint sysfs class");
MODULE_LICENSE("GPL");
